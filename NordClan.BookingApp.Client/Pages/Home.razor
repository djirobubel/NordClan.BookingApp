@page "/"
@using NordClan.BookingApp.Shared.Models
@using NordClan.BookingApp.Client.Services
@inject IRoomService RoomService
@inject IBookingService BookingService
@inject IJSRuntime JS
@implements IDisposable

<div class="container-fluid p-0">
    <div class="row flex-nowrap">
        <div class="col-auto px-0 bg-light" style="min-width: 250px;">
            <div class="p-3">
                <h3>Комнаты</h3>
                @if (rooms == null)
                {
                    <p>Загрузка...</p>
                }
                else
                {
                    <div class="list-group">
                        <a href="javascript:;" class="list-group-item list-group-item-action @(selectedRoomId == null ? "active" : "")" @onclick="() => SelectRoom(null)">Все комнаты</a>
                        @foreach (var room in rooms)
                        {
                            <a href="javascript:;" class="list-group-item list-group-item-action @(selectedRoomId == room.Id ? "active" : "")" @onclick="() => SelectRoom(room.Id)">
                                @room.Name
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
        <div class="col p-3">
            <h2>Бронирования</h2>
            <div id="calendar"></div>
        </div>
    </div>
</div>


<div class="modal fade @(modalClass)" tabindex="-1" style="display: @(modalDisplay);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@(currentBookingId > 0 ? "Редактировать" : "Новая бронь")</h5>
                <button type="button" class="btn-close" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Комната</label>
                    <select class="form-select" @bind="currentBooking.RoomId">
                        @if (rooms != null)
                        {
                            @foreach (var room in rooms)
                            {
                                <option value="@room.Id">@room.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input class="form-control" @bind="currentBooking.Title" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Описание</label>
                    <textarea class="form-control" @bind="currentBooking.Description"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Начало</label>
                    <input type="datetime-local" class="form-control" @bind="displayStartTime" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Конец</label>
                    <input type="datetime-local" class="form-control" @bind="displayEndTime" />
                </div>

                <!-- ←←← КРАСНЫЙ АЛЕРТ С ОШИБКОЙ ЗДЕСЬ! ПОД ВСЕМИ ПОЛЯМИ →→→ -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mt-4" role="alert">
                        <strong>Ошибка:</strong> @errorMessage
                    </div>
                }
            </div>
            <div class="modal-footer">
                @if (currentBookingId > 0)
                {
                    <button class="btn btn-danger" @onclick="DeleteBooking">Удалить</button>
                }
                <button class="btn btn-primary" @onclick="SaveBooking">Сохранить</button>
                <button class="btn btn-secondary" @onclick="CloseModal">Отмена</button>
            </div>
        </div>
    </div>
</div>

<footer class="fixed-bottom bg-dark text-white text-center py-2">
    Время ответа API: @responseTime
</footer>

@code {
    // private List<Room>? rooms;
    // private List<Booking> bookings = new();
    // private int? selectedRoomId;
    // private BookingRequest currentBooking = new();
    // private int currentBookingId = 0;
    // private string modalClass = "";
    // private string modalDisplay = "none";
    // private string responseTime = "0 мс";  

    // protected override async Task OnInitializedAsync()
    // {
    //     ResponseTimeService.OnTimeUpdated += UpdateFooter;

    //     rooms = await RoomService.GetRoomsAsync();
    //     await LoadBookings();
    // }

    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (firstRender)
    //     {
    //         await JS.InvokeVoidAsync("initCalendar", DotNetObjectReference.Create(this));
    //         await LoadBookings();
    //         await JS.InvokeVoidAsync("updateEvents", bookings);
    //     }
    // }

    // private async Task LoadBookings()
    // {
    //     bookings = await BookingService.GetBookingsAsync(selectedRoomId, null);
    //     await JS.InvokeVoidAsync("updateEvents", bookings);
    // }

    // private async Task SelectRoom(int? roomId)
    // {
    //     selectedRoomId = roomId;
    //     await LoadBookings();
    // }

    private List<Room>? rooms;
    private List<Booking> bookings = new();
    private int? selectedRoomId;
    private BookingRequest currentBooking = new();
    private int currentBookingId = 0;
    private string modalClass = "";
    private string modalDisplay = "none";
    private string responseTime = "0 мс";
    private DateTime displayStartTime;
    private DateTime displayEndTime;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        ResponseTimeService.OnTimeUpdated += UpdateFooter;
        rooms = await RoomService.GetRoomsAsync();
        await LoadBookings(); // ← ОСТАВЛЯЕМ ТОЛЬКО ЗДЕСЬ!
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initCalendar", DotNetObjectReference.Create(this));
            // УБРАЛ LoadBookings() ОТСЮДА — БЫЛ ДУБЛЬ!
        }
    }

    private async Task LoadBookings()
    {
        var stopwatch = System.Diagnostics.Stopwatch.StartNew();
        bookings = await BookingService.GetBookingsAsync(selectedRoomId, null);
        stopwatch.Stop();
        ResponseTimeService.UpdateTime($"{stopwatch.ElapsedMilliseconds} мс");

        await JS.InvokeVoidAsync("updateEvents", bookings); // ← ТОЛЬКО ЗДЕСЬ!
        StateHasChanged();
    }

    private async Task SelectRoom(int? roomId)
    {
        selectedRoomId = roomId;
        await LoadBookings();
    }

    [JSInvokable]
    public async Task OpenModal(string startIso, string endIso, int? bookingId = null)
    {
        // ← ПАРСИМ КАК UTC (FullCalendar даёт в UTC)
        var startUtc = DateTime.Parse(startIso, null, System.Globalization.DateTimeStyles.AssumeUniversal).ToUniversalTime();
        var endUtc = DateTime.Parse(endIso, null, System.Globalization.DateTimeStyles.AssumeUniversal).ToUniversalTime();

        // ← ЛОКАЛЬНОЕ ДЛЯ ОТОБРАЖЕНИЯ
        displayStartTime = startUtc.ToLocalTime();
        displayEndTime = endUtc.ToLocalTime();

        currentBookingId = bookingId ?? 0;
        currentBooking = new()
            {
                RoomId = selectedRoomId ?? rooms?.FirstOrDefault()?.Id ?? 1,
                StartTime = startUtc,  // ← ВСЕГДА UTC ДЛЯ API!
                EndTime = endUtc,
                Title = "",
                Description = ""
            };

        if (bookingId.HasValue && bookingId > 0)
        {
            var booking = bookings.FirstOrDefault(b => b.Id == bookingId);
            if (booking != null)
            {
                currentBooking = new()
                    {
                        RoomId = booking.RoomId,
                        StartTime = booking.StartTime,  // Уже UTC из БД
                        EndTime = booking.EndTime,
                        Title = booking.Title,
                        Description = booking.Description ?? ""
                    };

                // ← Обновляем отображение
                displayStartTime = booking.StartTime.ToLocalTime();
                displayEndTime = booking.EndTime.ToLocalTime();
            }
        }

        modalClass = "show";
        modalDisplay = "block";
        StateHasChanged();
    }

    private async Task SaveBooking()
    {
        errorMessage = ""; // ← СБРАСЫВАЕМ ПЕРЕД ПОПЫТКОЙ
        StateHasChanged();

        try
        {
            // ← ВОССТАНАВЛИВАЕМ UTC ИЗ DISPLAY
            currentBooking.StartTime = displayStartTime.ToUniversalTime();
            currentBooking.EndTime = displayEndTime.ToUniversalTime();

            if (currentBookingId > 0)
            {
                await BookingService.UpdateBookingAsync(currentBookingId, currentBooking);
            }
            else
            {
                await BookingService.CreateBookingAsync(currentBooking);
            }

            CloseModal();
            await LoadBookings();
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.BadRequest ||
                                              ex.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            // ← ЛОВИМ 400 И 409!
            errorMessage = ex.Message; // ← СООБЩЕНИЕ ИЗ API (то, что мы возвращаем в BadRequest/Conflict)
            StateHasChanged(); // ← ПОКАЗЫВАЕМ В МОДАЛКЕ
        }
        catch (Exception ex)
        {
            errorMessage = "Неизвестная ошибка: " + ex.Message;
            StateHasChanged();
        }
    }

    private async Task DeleteBooking()
    {
        if (currentBookingId > 0)
        {
            await BookingService.DeleteBookingAsync(currentBookingId);
            CloseModal();
            await LoadBookings();
        }
    }

    private void CloseModal()
    {
        modalClass = "";
        modalDisplay = "none";
        currentBookingId = 0;
        errorMessage = ""; // ← СБРАСЫВАЕМ ПРИ ЗАКРЫТИИ
        StateHasChanged();
    }

    private void UpdateFooter(string time)
    {
        responseTime = time;
        StateHasChanged();
    }

    public void Dispose()
    {
        ResponseTimeService.OnTimeUpdated -= UpdateFooter;
    }
}